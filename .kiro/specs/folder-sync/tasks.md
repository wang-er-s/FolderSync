# 实现计划: 文件夹同步系统

## 概述

本实现计划将文件夹同步系统的设计转化为一系列增量式的编码任务。每个任务都建立在前面任务的基础上，最终将所有组件集成在一起。实现使用Python 3.8+和uv包管理器，采用严格的类型注解，并结合单元测试和基于属性的测试来确保正确性。

## 任务

- [x] 1. 项目结构和基础配置
  - 使用 `uv init` 初始化项目
  - 创建 pyproject.toml 配置文件（定义项目元数据和依赖）
  - 使用 `uv add` 添加依赖：PySide6, watchdog, pytest, hypothesis, pytest-qt, mypy
  - 创建 .python-version 文件指定Python版本
  - 创建项目目录结构（src/, tests/）
  - 配置mypy类型检查（mypy.ini）
  - 配置pytest测试框架（pyproject.toml中的[tool.pytest.ini_options]）
  - 创建基础的日志配置
  - _需求: 所有需求的基础_

- [ ] 2. 数据模型和配置管理
  - [ ] 2.1 实现数据模型类
    - 在 src/models.py 中创建 TaskConfig 数据类（使用 @dataclass）
    - 创建 AppConfig 数据类
    - 实现 to_dict() 和 from_dict() 方法
    - 添加完整的类型注解
    - _需求: 9.1, 10.2, 14.1_

  - [ ] 2.2 为数据模型编写单元测试
    - 测试数据类的创建和序列化
    - 测试边缘情况（空值、特殊字符）
    - _需求: 9.1, 10.2, 14.1_

  - [ ] 2.3 实现配置管理器 (ConfigManager)
    - 在 src/config_manager.py 中实现配置文件的加载和保存（JSON格式）
    - 实现任务配置的增删改查
    - 处理配置文件不存在或损坏的情况
    - 添加完整的类型注解
    - _需求: 10.2, 10.3, 14.1, 14.2, 14.3_

  - [ ] 2.4 为配置管理器编写单元测试
    - 测试配置文件的读写
    - 测试配置文件损坏时的恢复
    - 测试任务配置的CRUD操作
    - _需求: 10.2, 10.3, 14.1, 14.2, 14.3_

  - [ ] 2.5 编写配置持久化往返属性测试
    - **属性 17: 配置持久化往返**
    - **验证需求: 10.2, 10.3, 14.1, 14.3**
    - _需求: 10.2, 10.3, 14.1, 14.3_

- [ ] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 4. 文件同步核心功能
  - [ ] 4.1 实现文件事件处理器 (FileEventHandler)
    - 在 src/sync_task.py 中继承 watchdog.FileSystemEventHandler
    - 实现 on_created, on_modified, on_deleted, on_moved 方法
    - 添加完整的类型注解
    - _需求: 1.1, 2.1, 3.1, 4.3_

  - [ ] 4.2 实现同步任务类 (SyncTask)
    - 在 src/sync_task.py 中实现文件复制、删除、移动操作
    - 实现初始同步功能
    - 实现错误处理和重试机制
    - 集成 watchdog Observer
    - 添加完整的类型注解和日志记录
    - _需求: 1.1, 1.2, 1.3, 2.1, 3.1, 3.2, 4.1, 4.3, 6.1, 6.2, 6.3, 7.2, 7.3, 7.4, 7.5, 8.1, 8.2_

  - [ ] 4.3 为同步任务编写单元测试
    - 测试文件复制、删除、移动操作
    - 测试初始同步
    - 测试错误处理和重试
    - 使用临时目录进行测试
    - _需求: 1.1, 2.1, 3.1, 4.3, 6.2, 7.3, 7.4_

  - [ ] 4.4 编写文件创建同步属性测试
    - **属性 1: 文件创建同步**
    - **验证需求: 1.1, 1.2**
    - _需求: 1.1, 1.2_

  - [ ] 4.5 编写子目录文件创建同步属性测试
    - **属性 2: 子目录文件创建同步**
    - **验证需求: 1.3**
    - _需求: 1.3_

  - [ ] 4.6 编写文件修改同步属性测试
    - **属性 3: 文件修改同步**
    - **验证需求: 2.1, 2.2**
    - _需求: 2.1, 2.2_

  - [ ] 4.7 编写文件删除同步属性测试
    - **属性 4: 文件删除同步**
    - **验证需求: 3.1**
    - _需求: 3.1_

  - [ ] 4.8 编写目录删除同步属性测试
    - **属性 5: 目录删除同步**
    - **验证需求: 3.2, 4.2**
    - _需求: 3.2, 4.2_

  - [ ] 4.9 编写目录创建同步属性测试
    - **属性 6: 目录创建同步**
    - **验证需求: 4.1**
    - _需求: 4.1_

  - [ ] 4.10 编写文件移动同步属性测试
    - **属性 7: 文件移动同步**
    - **验证需求: 4.3**
    - _需求: 4.3_

  - [ ] 4.11 编写初始同步完整性属性测试
    - **属性 9: 初始同步完整性**
    - **验证需求: 6.2**
    - _需求: 6.2_

  - [ ] 4.12 编写初始同步覆盖属性测试
    - **属性 10: 初始同步覆盖**
    - **验证需求: 6.3**
    - _需求: 6.3_

- [ ] 5. 检查点 - 确保核心同步功能正常
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 任务管理和应用控制
  - [ ] 6.1 实现任务管理器 (TaskManager)
    - 在 src/task_manager.py 中实现任务的创建、删除、启动、停止
    - 维护任务状态字典
    - 实现任务隔离（独立线程）
    - 添加完整的类型注解
    - _需求: 5.1, 10.1, 10.4, 10.5, 15.4_

  - [ ] 6.2 为任务管理器编写单元测试
    - 测试任务的CRUD操作
    - 测试任务状态管理
    - 测试多任务并发
    - _需求: 10.1, 10.4, 10.5_

  - [ ] 6.3 编写多任务独立运行属性测试
    - **属性 16: 多任务独立运行**
    - **验证需求: 10.1**
    - _需求: 10.1_

  - [ ] 6.4 编写任务错误隔离属性测试
    - **属性 19: 任务错误隔离**
    - **验证需求: 10.5**
    - _需求: 10.5_

  - [ ] 6.5 编写任务停止隔离属性测试
    - **属性 22: 任务停止隔离**
    - **验证需求: 15.4**
    - _需求: 15.4_

  - [ ] 6.6 实现启动管理器 (StartupManager)
    - 在 src/startup_manager.py 中实现Windows注册表操作（添加/删除启动项）
    - 实现启动项状态检查
    - 添加完整的类型注解和错误处理
    - _需求: 12.2, 12.3_

  - [ ] 6.7 为启动管理器编写单元测试
    - 测试注册表操作（需要管理员权限或模拟）
    - 测试启动项状态检查
    - _需求: 12.2, 12.3_

  - [ ] 6.8 编写自启动注册表往返属性测试
    - **属性 21: 自启动注册表往返**
    - **验证需求: 12.2, 12.3**
    - _需求: 12.2, 12.3_

  - [ ] 6.9 实现应用控制器 (AppController)
    - 在 src/app_controller.py 中协调GUI和业务逻辑
    - 实现所有用户操作的处理方法
    - 集成 TaskManager, ConfigManager, StartupManager
    - 添加完整的类型注解
    - _需求: 所有需求_

  - [ ] 6.10 为应用控制器编写单元测试
    - 测试各种用户操作的处理
    - 使用模拟对象测试组件协作
    - _需求: 所有需求_

- [ ] 7. 检查点 - 确保业务逻辑层完整
  - 确保所有测试通过，如有问题请询问用户

- [ ] 8. GUI界面实现
  - [ ] 8.1 实现主窗口 (MainWindow)
    - 在 src/gui/main_window.py 中创建任务列表表格（QTableWidget）
    - 添加操作按钮（添加、删除、启动、停止、设置）
    - 实现任务列表的更新和状态显示
    - 实现窗口关闭时最小化到托盘
    - 添加完整的类型注解
    - _需求: 9.1, 9.2, 9.4, 9.5, 11.1_

  - [ ] 8.2 为主窗口编写单元测试
    - 使用 pytest-qt 测试GUI交互
    - 测试按钮点击事件
    - 测试任务列表更新
    - _需求: 9.1, 9.2, 9.4, 9.5_

  - [ ] 8.3 实现任务配置对话框 (TaskDialog)
    - 在 src/gui/task_dialog.py 中创建源文件夹和目标文件夹选择控件
    - 实现文件夹浏览对话框
    - 实现路径验证
    - 添加完整的类型注解
    - _需求: 9.2_

  - [ ] 8.4 为任务配置对话框编写单元测试
    - 测试对话框的创建和数据获取
    - 测试路径验证逻辑
    - _需求: 9.2_

  - [ ] 8.5 实现设置对话框 (SettingsDialog)
    - 在 src/gui/settings_dialog.py 中创建开机自启动复选框
    - 创建日志级别选择下拉框
    - 实现设置的保存和加载
    - 添加完整的类型注解
    - _需求: 8.4, 12.1_

  - [ ] 8.6 为设置对话框编写单元测试
    - 测试设置的保存和加载
    - 测试UI控件的交互
    - _需求: 8.4, 12.1_

  - [ ] 8.7 实现系统托盘 (SystemTray)
    - 在 src/gui/system_tray.py 中创建托盘图标和菜单
    - 实现托盘图标点击事件（显示/隐藏窗口）
    - 实现托盘通知功能
    - 添加完整的类型注解
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ] 8.8 为系统托盘编写单元测试
    - 测试托盘图标的创建
    - 测试菜单交互
    - 测试通知显示
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 9. 应用程序入口和集成
  - [ ] 9.1 创建主程序入口 (main.py)
    - 在 src/main.py 中初始化 QApplication
    - 创建 AppController
    - 创建 MainWindow 和 SystemTray
    - 实现优雅退出（信号处理）
    - 添加完整的类型注解
    - _需求: 5.1, 6.1, 15.1, 15.3_

  - [ ] 9.2 集成所有组件
    - 连接GUI信号和控制器槽
    - 实现组件间的通信
    - 确保线程安全
    - _需求: 所有需求_

  - [ ] 9.3 编写端到端集成测试
    - 测试完整的用户工作流
    - 测试多任务场景
    - 测试错误恢复
    - _需求: 所有需求_

- [ ] 10. 检查点 - 确保应用程序完整运行
  - 确保所有测试通过，如有问题请询问用户

- [ ] 11. 打包和部署
  - [ ] 11.1 创建应用程序图标
    - 设计或选择应用程序图标（.ico格式）
    - _需求: 11.4, 13.4_

  - [ ] 11.2 配置PyInstaller
    - 使用 `uv add --dev pyinstaller` 添加PyInstaller为开发依赖
    - 创建 .spec 文件
    - 配置打包选项（--onefile, --windowed, --icon）
    - 包含必要的数据文件
    - _需求: 13.1, 13.2, 13.4_

  - [ ] 11.3 测试打包后的可执行文件
    - 在干净的Windows环境中测试
    - 验证所有功能正常工作
    - _需求: 13.3_

  - [ ] 11.4 创建用户文档
    - 编写README.md（使用说明）
    - 创建安装和卸载指南
    - _需求: 所有需求_

- [ ] 12. 最终检查点
  - 使用 `uv run pytest` 运行所有测试（单元测试和属性测试）
  - 使用 `uv run mypy src` 运行类型检查
  - 手动测试所有功能
  - 确认所有需求都已实现

## 注意事项

- 使用 uv 管理所有依赖和虚拟环境
- 运行测试: `uv run pytest`
- 运行类型检查: `uv run mypy src`
- 运行应用: `uv run python -m folder_sync.main`
- 每个任务都引用了它实现的具体需求
- 检查点任务确保增量验证
- 属性测试使用Hypothesis库，每个测试运行至少100次迭代
- 所有代码必须通过mypy严格类型检查
- 单元测试和属性测试是互补的，共同确保代码正确性
